import { useMemo, useState } from "react";

// Drop this component into any Mintlify MDX page and render with <MinTransactionCalculator />
export function MinTransactionCalculator() {
  // --- Data --------------------------------------------------------------
  const currencyToSourceRails: Record<string, string[]> = {
    mxn: ["spei"],
    usd: ["ach"],
    euro: ["sepa"],
    usdc: [
      "ethereum",
      "polygon",
      "base",
      "arbitrum",
      "avalanche",
      "optimism",
      "solana",
      "stellar",
    ],
    usdt: ["ethereum", "tron"],
    dai: ["ethereum"],
    usdp: ["ethereum"],
    pyusd: ["ethereum", "solana"],
    eurc: ["solana"],
    btc: ["bitcoin"],
    eth: ["ethereum"],
    usdb: ["bridge_wallet"],
  };

  const currencyToDestRails: Record<string, string[]> = {
    mxn: ["spei"],
    usd: ["ach_push", "ach_same_day"],
    euro: ["sepa"],
    usdc: [
      "ethereum",
      "polygon",
      "base",
      "arbitrum",
      "avalanche",
      "optimism",
      "solana",
      "stellar",
    ],
    usdt: ["ethereum", "tron"],
    dai: ["ethereum"],
    usdp: ["ethereum"],
    pyusd: ["ethereum", "solana"],
    eurc: ["solana"],
    btc: ["bitcoin"],
    eth: ["ethereum"],
    usdb: ["bridge_wallet"],
  };

  const allCurrencies = useMemo(
    () => Object.keys(currencyToSourceRails),
    []
  );

  const allRails = useMemo(() => {
    const merged = [
      ...Object.values(currencyToSourceRails).flat(),
      ...Object.values(currencyToDestRails).flat(),
    ];
    return Array.from(new Set(merged));
  }, []);

  // --- Form state --------------------------------------------------------
  const [sourceCurrency, setSourceCurrency] = useState<string>("");
  const [sourceRail, setSourceRail] = useState<string>("");
  const [destCurrency, setDestCurrency] = useState<string>("");
  const [destRail, setDestRail] = useState<string>("");

  // --- Derived option sets ----------------------------------------------
  const sourceRailOptions = useMemo(() => {
    if (!sourceCurrency) return allRails;
    return currencyToSourceRails[sourceCurrency] || [];
  }, [sourceCurrency, allRails]);

  const sourceCurrencyOptions = useMemo(() => {
    if (!sourceRail) return allCurrencies;
    return allCurrencies.filter((cur) =>
      (currencyToSourceRails[cur] || []).includes(sourceRail)
    );
  }, [sourceRail, allCurrencies]);

  const destRailOptions = useMemo(() => {
    if (!destCurrency) return allRails;
    return currencyToDestRails[destCurrency] || [];
  }, [destCurrency, allRails]);

  const destCurrencyOptions = useMemo(() => {
    if (!destRail) return allCurrencies;
    return allCurrencies.filter((cur) =>
      (currencyToDestRails[cur] || []).includes(destRail)
    );
  }, [destRail, allCurrencies]);

  // --- Calculation logic (ported from original) -------------------------
  const fiats = ["usd", "euro", "mxn"] as const;
  const stable = ["usdc", "usdt", "usdp", "dai", "pyusd", "eurc"] as const;
  const nonStable = ["eth", "btc"] as const;
  const exchangeFee = ["dai", "usdt"] as const;
  const requiresGasForWithdrawal = ["btc", "dai", "eth", "usdt"] as const;
  const expensiveGas = ["bitcoin", "ethereum"] as const;

  function calculateMinimum() {
    const src = sourceCurrency.toLowerCase();
    const dst = destCurrency.toLowerCase();
    const rail = sourceRail.toLowerCase();
    const dRail = destRail.toLowerCase();

    // Fiat-to-fiat not yet
    if (fiats.includes(src as any) && fiats.includes(dst as any)) {
      return {
        type: "notice" as const,
        message:
          "üõ†Ô∏è Fiat-to-fiat transfers are not available yet, but coming soon!",
      };
    }

    let reasons: string[] = [];
    let base = 1.0;

    base = !fiats.includes(src as any)
      ? stable.includes(src as any)
        ? 1.0
        : 2.0
      : 1.0;

    let mins = [base];

    if (
      exchangeFee.includes(src as any) ||
      exchangeFee.includes(dst as any) ||
      nonStable.includes(src as any) ||
      nonStable.includes(dst as any)
    ) {
      mins.push(2);
      reasons.push("Exchange or crypto fee");
    }

    if (
      requiresGasForWithdrawal.includes(dst as any) &&
      expensiveGas.includes(dRail as any)
    ) {
      mins.push(20);
      reasons.push("Gas cost on destination rail");
    }

    if (rail === "tron" || dRail === "tron") {
      mins.push(5);
      reasons.push("Tron adjustment");
    }

    if (src === "mxn") {
      mins.push(50);
      reasons.push("MXN source minimum");
    }
    if (dst === "mxn") {
      mins.push(2);
      reasons.push("MXN destination minimum");
    }

    const finalMin = Math.max(...mins);
    const displayCurrency = src.toUpperCase();

    return {
      type: "result" as const,
      value: finalMin,
      currency: displayCurrency,
      reasons,
    };
  }

  const canCalculate =
    Boolean(sourceCurrency) &&
    Boolean(sourceRail) &&
    Boolean(destCurrency) &&
    Boolean(destRail);

  const [result, setResult] = useState<
    | { type: "empty" }
    | { type: "notice"; message: string }
    | { type: "result"; value: number; currency: string; reasons: string[] }
  >({ type: "empty" });

  function onCalculate() {
    const r = calculateMinimum();
    setResult(r as any);
  }

  function onReset() {
    setSourceCurrency("");
    setSourceRail("");
    setDestCurrency("");
    setDestRail("");
    setResult({ type: "empty" });
  }

  // --- UI ---------------------------------------------------------------
  const box = "rounded-xl border border-zinc-200 dark:border-zinc-700 p-4";
  const label = "text-sm font-medium";
  const select =
    "mt-1 w-full rounded-md border border-zinc-300 dark:border-zinc-600 bg-white dark:bg-zinc-900 px-3 py-2";
  const row = "grid grid-cols-1 md:grid-cols-2 gap-4";
  const btn =
    "rounded-lg px-4 py-2 border border-zinc-300 dark:border-zinc-600 hover:bg-zinc-50 dark:hover:bg-zinc-800 disabled:opacity-50";

  const sorted = (arr: string[]) => arr.slice().sort((a, b) => a.localeCompare(b));

  return (
    <div className="not-prose">
      <h2 className="text-lg font-semibold mb-3">Minimum Transaction Calculator</h2>

      <div className={box}>
        <fieldset className="mb-4">
          <legend className="text-sm font-semibold mb-2">Source</legend>
          <div className={row}>
            <div>
              <label className={label} htmlFor="srcCurrency">
                Source Currency
              </label>
              <select
                id="srcCurrency"
                className={select}
                value={sourceCurrency}
                onChange={(e) => setSourceCurrency(e.target.value)}
              >
                <option value="">-- Select --</option>
                {sorted(sourceCurrencyOptions).map((opt) => (
                  <option key={opt} value={opt}>
                    {opt.toUpperCase()}
                  </option>
                ))}
              </select>
            </div>

            <div>
              <label className={label} htmlFor="srcRail">
                Source Payment Rail
              </label>
              <select
                id="srcRail"
                className={select}
                value={sourceRail}
                onChange={(e) => setSourceRail(e.target.value)}
              >
                <option value="">-- Select --</option>
                {sorted(sourceRailOptions).map((opt) => (
                  <option key={opt} value={opt}>
                    {opt}
                  </option>
                ))}
              </select>
            </div>
          </div>
        </fieldset>

        <fieldset className="mb-4">
          <legend className="text-sm font-semibold mb-2">Destination</legend>
          <div className={row}>
            <div>
              <label className={label} htmlFor="dstCurrency">
                Destination Currency
              </label>
              <select
                id="dstCurrency"
                className={select}
                value={destCurrency}
                onChange={(e) => setDestCurrency(e.target.value)}
              >
                <option value="">-- Select --</option>
                {sorted(destCurrencyOptions).map((opt) => (
                  <option key={opt} value={opt}>
                    {opt.toUpperCase()}
                  </option>
                ))}
              </select>
            </div>

            <div>
              <label className={label} htmlFor="dstRail">
                Destination Payment Rail
              </label>
              <select
                id="dstRail"
                className={select}
                value={destRail}
                onChange={(e) => setDestRail(e.target.value)}
              >
                <option value="">-- Select --</option>
                {sorted(destRailOptions).map((opt) => (
                  <option key={opt} value={opt}>
                    {opt}
                  </option>
                ))}
              </select>
            </div>
          </div>
        </fieldset>

        <div className="flex gap-2">
          <button className={btn} onClick={onCalculate} disabled={!canCalculate}>
            Calculate Minimum
          </button>
          <button className={btn} onClick={onReset}>Reset</button>
        </div>

        <div className="mt-4 text-sm">
          {result.type === "empty" && <span>Minimum required: ‚Äî</span>}
          {result.type === "notice" && (
            <span role="status">{result.message}</span>
          )}
          {result.type === "result" && (
            <div>
              <div>
                Minimum required: {result.value.toFixed(2)} {result.currency}
              </div>
              <div className="text-zinc-500 mt-1">
                <small>
                  Reason: {result.reasons.length ? result.reasons.join(", ") : "base minimum applied"}
                </small>
              </div>
            </div>
          )}
        </div>
      </div>
    </div>
  );
}

export default function Counter() {
  // to preserve the original export name in your MDX if desired
  return <MinTransactionCalculator />;
}
