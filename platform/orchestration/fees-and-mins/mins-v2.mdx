export default function MinimumTransactionCalculator() {
  const currencyToSourceRails = {
    mxn: ["spei"],
    usd: ["ach"],
    euro: ["sepa"],
    usdc: ["ethereum", "polygon", "base", "arbitrum", "avalanche", "optimism", "solana", "stellar"],
    usdt: ["ethereum", "tron"],
    dai: ["ethereum"],
    usdp: ["ethereum"],
    pyusd: ["ethereum", "solana"],
    eurc: ["solana"],
    btc: ["bitcoin"],
    eth: ["ethereum"],
    usdb: ["bridge_wallet"],
  } as const;

  const currencyToDestRails = {
    mxn: ["spei"],
    usd: ["ach_push", "ach_same_day"],
    euro: ["sepa"],
    usdc: ["ethereum", "polygon", "base", "arbitrum", "avalanche", "optimism", "solana", "stellar"],
    usdt: ["ethereum", "tron"],
    dai: ["ethereum"],
    usdp: ["ethereum"],
    pyusd: ["ethereum", "solana"],
    eurc: ["solana"],
    btc: ["bitcoin"],
    eth: ["ethereum"],
    usdb: ["bridge_wallet"],
  } as const;

  const allCurrencies = Object.keys(currencyToSourceRails);
  const allRails = Array.from(
    new Set(
      Object.values(currencyToSourceRails).flat().concat(Object.values(currencyToDestRails).flat())
    )
  );

  const [sourceCurrency, setSourceCurrency] = React.useState("");
  const [sourceRail, setSourceRail] = React.useState("");
  const [destCurrency, setDestCurrency] = React.useState("");
  const [destRail, setDestRail] = React.useState("");
  const [result, setResult] = React.useState("Minimum required: ‚Äî");

  function sorted(arr) {
    return arr.slice().sort((a, b) => a.localeCompare(b));
  }

  function populateRailsFor(currency, map) {
    if (!currency) return sorted(allRails);
    return sorted(map[currency] || []);
  }

  function populateCurrenciesFor(rail, map) {
    if (!rail) return sorted(allCurrencies);
    return sorted(allCurrencies.filter((cur) => (map[cur] || []).includes(rail)));
  }

  const sourceRailOptions = React.useMemo(
    () => populateRailsFor(sourceCurrency, currencyToSourceRails),
    [sourceCurrency]
  );
  const destRailOptions = React.useMemo(
    () => populateRailsFor(destCurrency, currencyToDestRails),
    [destCurrency]
  );
  const sourceCurrencyOptions = React.useMemo(
    () => populateCurrenciesFor(sourceRail, currencyToSourceRails),
    [sourceRail]
  );
  const destCurrencyOptions = React.useMemo(
    () => populateCurrenciesFor(destRail, currencyToDestRails),
    [destRail]
  );

  // Keep selections valid if options shrink
  React.useEffect(() => {
    if (sourceRail && !sourceRailOptions.includes(sourceRail)) setSourceRail("");
  }, [sourceRailOptions]);
  React.useEffect(() => {
    if (destRail && !destRailOptions.includes(destRail)) setDestRail("");
  }, [destRailOptions]);
  React.useEffect(() => {
    if (sourceCurrency && !sourceCurrencyOptions.includes(sourceCurrency)) setSourceCurrency("");
  }, [sourceCurrencyOptions]);
  React.useEffect(() => {
    if (destCurrency && !destCurrencyOptions.includes(destCurrency)) setDestCurrency("");
  }, [destCurrencyOptions]);

  const canCalculate = Boolean(sourceCurrency && sourceRail && destCurrency && destRail);

  function onCalculate() {
    const src = sourceCurrency.toLowerCase();
    const dst = destCurrency.toLowerCase();
    const rail = sourceRail.toLowerCase();
    const dstR = destRail.toLowerCase();

    const fiats = ["usd", "euro", "mxn"]; 
    if (fiats.includes(src) && fiats.includes(dst)) {
      setResult(
        'Minimum required: ‚Äî\n' +
          'üõ†Ô∏è Fiat-to-fiat transfers are not available yet, but coming soon!'
      );
      return;
    }

    const reasons: string[] = [];
    let base = 1.0;
    const stable = ["usdc", "usdt", "usdp", "dai", "pyusd", "eurc"];
    const nonStable = ["eth", "btc"];
    const exchangeFee = ["dai", "usdt"];
    const requiresGasForWithdrawal = ["btc", "dai", "eth", "usdt"];
    const expensiveGas = ["bitcoin", "ethereum"];

    base = !fiats.includes(src) ? (stable.includes(src) ? 1.0 : 2.0) : 1.0;

    const mins: number[] = [base];

    if (
      exchangeFee.includes(src) ||
      exchangeFee.includes(dst) ||
      nonStable.includes(src) ||
      nonStable.includes(dst)
    ) {
      mins.push(2);
      reasons.push("Exchange or crypto fee");
    }

    if (requiresGasForWithdrawal.includes(dst) && expensiveGas.includes(dstR)) {
      mins.push(20);
      reasons.push("Gas cost on destination rail");
    }

    if (rail === "tron" || dstR === "tron") {
      mins.push(5);
      reasons.push("Tron adjustment");
    }

    if (src === "mxn") {
      mins.push(50);
      reasons.push("MXN source minimum");
    }
    if (dst === "mxn") {
      mins.push(2);
      reasons.push("MXN destination minimum");
    }

    const finalMin = Math.max(...mins);
    const displayCurrency = src.toUpperCase();

    setResult(
      `Minimum required: ${finalMin.toFixed(2)} ${displayCurrency}\nReason: ${
        reasons.join(", ") || "base minimum applied"
      }`
    );
  }

  function onReset() {
    setSourceCurrency("");
    setSourceRail("");
    setDestCurrency("");
    setDestRail("");
    setResult("Minimum required: ‚Äî");
  }

  return (
    <div className="container">
      <h2>Minimum Transaction Calculator</h2>

      <fieldset className="group">
        <legend>Source</legend>
        <div className="row">
          <div className="field">
            <label htmlFor="sourceCurrency">Source Currency</label>
            <select
              id="sourceCurrency"
              value={sourceCurrency}
              onChange={(e) => setSourceCurrency(e.target.value)}
            >
              <option value="">-- Select --</option>
              {sourceCurrencyOptions.map((opt) => (
                <option key={opt} value={opt}>
                  {opt.toUpperCase()}
                </option>
              ))}
            </select>
          </div>
          <div className="field">
            <label htmlFor="sourceRail">Source Payment Rail</label>
            <select
              id="sourceRail"
              value={sourceRail}
              onChange={(e) => setSourceRail(e.target.value)}
            >
              <option value="">-- Select --</option>
              {sourceRailOptions.map((opt) => (
                <option key={opt} value={opt}>
                  {opt.toUpperCase()}
                </option>
              ))}
            </select>
          </div>
        </div>
      </fieldset>

      <fieldset className="group">
        <legend>Destination</legend>
        <div className="row">
          <div className="field">
            <label htmlFor="destCurrency">Destination Currency</label>
            <select
              id="destCurrency"
              value={destCurrency}
              onChange={(e) => setDestCurrency(e.target.value)}
            >
              <option value="">-- Select --</option>
              {destCurrencyOptions.map((opt) => (
                <option key={opt} value={opt}>
                  {opt.toUpperCase()}
                </option>
              ))}
            </select>
          </div>
          <div className="field">
            <label htmlFor="destRail">Destination Payment Rail</label>
            <select
              id="destRail"
              value={destRail}
              onChange={(e) => setDestRail(e.target.value)}
            >
              <option value="">-- Select --</option>
              {destRailOptions.map((opt) => (
                <option key={opt} value={opt}>
                  {opt.toUpperCase()}
                </option>
              ))}
            </select>
          </div>
        </div>
      </fieldset>

      <div className="button-row">
        <button id="calculateBtn" disabled={!canCalculate} onClick={onCalculate}>
          Calculate Minimum
        </button>
        <button id="resetBtn" onClick={onReset}>Reset</button>
      </div>

      <div id="result" className="resultBox">
        {result.split("\n").map((line, i) => (
          <div key={i}>{line}</div>
        ))}
      </div>

      <style>{`
        body {
          font-family: sans-serif;
          padding: 20px;
        }
        .container {
          max-width: 640px;
          margin: 0 auto;
        }
        .row {
          display: flex;
          gap: 10px;
          margin-bottom: 15px;
          flex-wrap: wrap;
        }
        .field {
          flex: 1;
          min-width: 220px;
        }
        label {
          font-weight: bold;
          display: block;
          margin-bottom: 4px;
        }
        select, button {
          width: 100%;
          padding: 8px;
          font-size: 1rem;
        }
        button {
          margin-top: 10px;
          cursor: pointer;
        }
        button:disabled {
          opacity: 0.6;
          cursor: not-allowed;
        }
        #result {
          margin-top: 20px;
          font-weight: bold;
        }
        .group {
          border: 1px solid #ccc;
          padding: 15px;
          border-radius: 6px;
          margin-bottom: 20px;
        }
        .group legend {
          font-weight: bold;
          padding: 0 8px;
        }
        .button-row {
          display: flex;
          gap: 10px;
        }
      `}</style>
    </div>
  );
}